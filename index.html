<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>ржЯрж╛ржХрж╛ рж░рзЗржХрж░рзНржб рж╕рж┐рж╕рзНржЯрзЗржо</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; background: #f9f9f9; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    h2 { text-align: center; }
    input, button, select { padding: 8px; margin-top: 10px; width: 100%; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .actions button { margin: 2px; }
    #logout { float: right; }
  </style>
</head>
<body>

<div class="container" id="loginContainer">
  <h2>ЁЯФР рж▓ржЧржЗржи ржХрж░рзБржи</h2>
  <input type="email" id="email" placeholder="ржЗржорзЗржЗрж▓">
  <input type="password" id="password" placeholder="ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб">
  <button onclick="login()">рж▓ржЧржЗржи</button>
</div>

<div class="container" id="mainContainer" style="display:none;">
  <h2>ЁЯТ░ ржЯрж╛ржХрж╛ рж░рзЗржХрж░рзНржб рж╕рж┐рж╕рзНржЯрзЗржо <button id="logout" onclick="logout()">ЁЯЪк рж▓ржЧржЖржЙржЯ</button></h2>

  <form id="moneyForm">
    <input type="text" id="name" placeholder="ржирж╛ржо" required>
    <input type="text" id="address" placeholder="ржарж┐ржХрж╛ржирж╛" required>
    <input type="number" id="amount" placeholder="ржорзЛржЯ ржЯрж╛ржХрж╛" required>
    <input type="number" id="paid" placeholder="ржЬржорж╛" required>
    <input type="date" id="date" required>
    <input type="time" id="time" required>
    <button type="submit">рж╕рзЗржн ржХрж░рзБржи</button>
  </form>

  <input type="text" id="search" placeholder="ЁЯФН рж╕рж╛рж░рзНржЪ ржирж╛ржо/ржарж┐ржХрж╛ржирж╛" />
  <select id="filterDue">
    <option value="all">рж╕ржм</option>
    <option value="due">ржпрж╛ржжрзЗрж░ ржмрж╛ржХрж┐ ржЖржЫрзЗ</option>
  </select>
  <input type="date" id="filterDate" />

  <button onclick="downloadPDF()">ЁЯУД PDF</button>
  <button onclick="downloadExcel()">ЁЯУК Excel</button>

  <table>
    <thead>
      <tr>
        <th>ржирж╛ржо</th><th>ржарж┐ржХрж╛ржирж╛</th><th>ржорзЛржЯ</th><th>ржЬржорж╛</th><th>ржмрж╛ржХрж┐</th><th>рждрж╛рж░рж┐ржЦ</th><th>рж╕ржорзЯ</th><th>ржЕржкрж╢ржи</th>
      </tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyASbCt9rJxQbo-tAtDZ_ZjcarnDjHt_kV0",
    authDomain: "money-record-app-b99ac.firebaseapp.com",
    projectId: "money-record-app-b99ac",
    storageBucket: "money-record-app-b99ac.firebasestorage.app",
    messagingSenderId: "1063647502694",
    appId: "1:1063647502694:web:eb6bf014e01143d348a8a7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginContainer = document.getElementById("loginContainer");
  const mainContainer = document.getElementById("mainContainer");
  const form = document.getElementById("moneyForm");
  const tableBody = document.getElementById("dataTable");
  const searchInput = document.getElementById("search");
  const filterDue = document.getElementById("filterDue");
  const filterDate = document.getElementById("filterDate");

  let currentEditId = null;
  let fullData = [];

  auth.onAuthStateChanged(user => {
    if (user) {
      loginContainer.style.display = "none";
      mainContainer.style.display = "block";
      loadData();
    } else {
      loginContainer.style.display = "block";
      mainContainer.style.display = "none";
    }
  });

  function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
  }

  function logout() {
    auth.signOut();
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    const newData = {
      name: form.name.value,
      address: form.address.value,
      amount: Number(form.amount.value),
      paid: Number(form.paid.value),
      date: form.date.value,
      time: form.time.value
    };
    if (currentEditId) {
      db.collection("records").doc(currentEditId).update(newData).then(() => {
        form.reset(); currentEditId = null;
      });
    } else {
      db.collection("records").add(newData).then(() => form.reset());
    }
  });

  window.editData = async (id) => {
    const doc = await db.collection("records").doc(id).get();
    const d = doc.data();
    form.name.value = d.name;
    form.address.value = d.address;
    form.amount.value = d.amount;
    form.paid.value = d.paid;
    form.date.value = d.date;
    form.time.value = d.time;
    currentEditId = id;
  };

  window.deleteData = id => {
    if (confirm("ржбрж┐рж▓рж┐ржЯ ржХрж░рждрзЗ ржЪрж╛ржи?")) db.collection("records").doc(id).delete();
  };

  function renderData(docs) {
    tableBody.innerHTML = "";
    fullData = docs;
    docs.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.name}</td><td>${d.address}</td><td>${d.amount}</td><td>${d.paid}</td>
        <td>${d.amount - d.paid}</td><td>${d.date}</td><td>${d.time}</td>
        <td>
          <button onclick="editData('${doc.id}')">тЬПя╕П</button>
          <button onclick="deleteData('${doc.id}')">тЭМ</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  function applyFilters() {
    let keyword = searchInput.value.toLowerCase();
    let date = filterDate.value;
    let due = filterDue.value;

    let filtered = fullData.filter(doc => {
      let d = doc.data();
      let matchSearch = d.name.toLowerCase().includes(keyword) || d.address.toLowerCase().includes(keyword);
      let matchDate = date ? d.date === date : true;
      let matchDue = due === "due" ? d.amount > d.paid : true;
      return matchSearch && matchDate && matchDue;
    });
    renderData(filtered);
  }

  searchInput.addEventListener("input", applyFilters);
  filterDate.addEventListener("change", applyFilters);
  filterDue.addEventListener("change", applyFilters);

  function loadData() {
    db.collection("records").onSnapshot(snapshot => {
      renderData(snapshot.docs);
    });
  }

  function downloadExcel() {
    const data = fullData.map(doc => {
      const d = doc.data();
      return {
        ржирж╛ржо: d.name,
        ржарж┐ржХрж╛ржирж╛: d.address,
        ржорзЛржЯ: d.amount,
        ржЬржорж╛: d.paid,
        ржмрж╛ржХрж┐: d.amount - d.paid,
        рждрж╛рж░рж┐ржЦ: d.date,
        рж╕ржорзЯ: d.time
      };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Records");
    XLSX.writeFile(wb, "Records.xlsx");
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text("ржЯрж╛ржХрж╛ рж░рзЗржХрж░рзНржб рж░рж┐ржкрзЛрж░рзНржЯ", 10, 10);
    let y = 20;
    fullData.forEach(doc => {
      const d = doc.data();
      const row = `ржирж╛ржо: ${d.name}, ржарж┐ржХрж╛ржирж╛: ${d.address}, ржорзЛржЯ: ${d.amount}, ржЬржорж╛: ${d.paid}, ржмрж╛ржХрж┐: ${d.amount - d.paid}, рждрж╛рж░рж┐ржЦ: ${d.date}, рж╕ржорзЯ: ${d.time}`;
      pdf.text(row, 10, y);
      y += 10;
    });
    pdf.save("records.pdf");
  }
</script>
</body>
</html>
